FROM ubuntu:latest
MAINTAINER Nicolas Mauchle <nicolas@nicolasmauchle.ch>

RUN apt-get update && apt-get install -y python3-pip git libpq-dev nginx supervisor

COPY reanalytics.conf etc/nginx/sites-available/
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
RUN locale-gen en_US.UTF-8

WORKDIR /root

RUN rm /etc/nginx/sites-enabled/default \
    && ln -s /etc/nginx/sites-available/reanalytics.conf /etc/nginx/sites-enabled/reanalytics.conf \
    && echo "daemon off;" >> /etc/nginx/nginx.conf


# Clone repo
RUN git clone https://github.com/bhzunami/reanalytics.git


RUN mkdir /root/reanalytics/data \
    && mkdir /root/reanalytics/report \
    && mkdir /root/reanalytics/logs \
    && pip3 install -r /root/reanalytics/requirements.txt \
    && chown -R www-data:www-data /root/reanalytics \
    && chown -R www-data:www-data /var/log

ENV FLASK_CONFIG=production

# FTP
ENV FTP_URL=server36.cyon.ch
ENV FTP_USER=niggi@studrat.ch
ENV FTP_PASSWORD=st-benno
ENV FTP_FILE_NAME=allesralle.xml
ENV FTP_INITIAL_FILE_NAME=allesralle_full.xml

#Avisum
ENV DEFAULT_USER_EMAIL=nmauchle@gmail.com
ENV DEFAULT_USER_NAME=Nicolas Mauchle
ENV DEFAULT_PASSWORD=Ki56vrz2xw

# SMTP
ENV SMTP_SERVER=smtp.nicolasmauchle.ch
ENV SMTP_USER=nicolas@nicolasmauchle.ch
ENV SMTP_PASSWORD=e5LR826RIj0oyzA_btt-


RUN mkdir /root/reports 
#CMD ["tail", "-f", "/dev/null"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

